/******************************************************************************
 *
 * Module: Main Application
 *
 * File Name: main.c
 *
 * Description: Main application for Car Parking Sensor System
 *
 * Author: Your Name
 *
 *******************************************************************************/

#include "MCAL/GPIO/GPIO.h"
#include "HAL/LCD/LCD.h"
#include "HAL/BUZZER/BUZZER.h"
#include "HAL/LED/LED.h"
#include "HAL/Ultrasonic/Ultrasonic.h"
#include <util/delay.h>

/*******************************************************************************
 *                                Definitions                                  *
 *******************************************************************************/

/* Distance thresholds in centimeters - Exactly as in PDF */
#define STOP_DISTANCE           5
#define VERY_CLOSE_DISTANCE     10
#define CLOSE_DISTANCE          15
#define MEDIUM_DISTANCE         20

/* Delay between measurements in milliseconds */
#define MEASUREMENT_DELAY       250

/*******************************************************************************
 *                      Functions Prototypes                                   *
 *******************************************************************************/

void ControlIndicators(uint16 distance);
void DisplayDistance(uint16 distance);

/*******************************************************************************
 *                      Functions Definitions                                  *
 *******************************************************************************/

void ControlIndicators(uint16 distance)
{
    /* Turn off all LEDs and buzzer first */
    LED_off(RED_LED);
    LED_off(GREEN_LED);
    LED_off(BLUE_LED);
    Buzzer_off();

    /* Exactly as specified in PDF */
    if (distance <= STOP_DISTANCE)
    {
        /* Distance <= 5 cm: All LEDs are flashing, Buzzer sounds */
        LED_on(RED_LED);
        LED_on(GREEN_LED);
        LED_on(BLUE_LED);
        Buzzer_on();
        _delay_ms(100);
        LED_off(RED_LED);
        LED_off(GREEN_LED);
        LED_off(BLUE_LED);
        Buzzer_off();
        _delay_ms(100);
    }
    else if (distance >= 6 && distance <= VERY_CLOSE_DISTANCE)
    {
        /* 6-10 cm: All LEDs ON, No buzzer */
        LED_on(RED_LED);
        LED_on(GREEN_LED);
        LED_on(BLUE_LED);
    }
    else if (distance >= 11 && distance <= CLOSE_DISTANCE)
    {
        /* 11-15 cm: Red and Green LEDs ON, Blue LED OFF */
        LED_on(RED_LED);
        LED_on(GREEN_LED);
        LED_off(BLUE_LED);
    }
    else if (distance >= 16 && distance <= MEDIUM_DISTANCE)
    {
        /* 16-20 cm: Only Red LED ON, others OFF */
        LED_on(RED_LED);
        LED_off(GREEN_LED);
        LED_off(BLUE_LED);
    }
    else
    {
        /* >20 cm: All LEDs OFF, Buzzer OFF */
        LED_off(RED_LED);
        LED_off(GREEN_LED);
        LED_off(BLUE_LED);
        Buzzer_off();
    }
}

void DisplayDistance(uint16 distance)
{
    /* Clear only specific parts to avoid flickering */
    LCD_moveCursur(0, 0);
    LCD_displayString("Distance:    cm");

    /* Update distance value */
    LCD_moveCursur(0, 10);
    if (distance < 100) {
        LCD_displayString(" ");
    }
    if (distance < 10) {
        LCD_displayString(" ");
    }
    LCD_itos(distance);

    /* Display warning message as per PDF */
    LCD_moveCursur(1, 0);
    if (distance <= STOP_DISTANCE)
    {
        LCD_displayString("     STOP!     ");
    }
    else
    {
        LCD_displayString("               ");
    }
}

int main(void)
{
    uint16 distance = 0;

    /* Initialize all drivers */
    LCD_init();             /* Initialize LCD display */
    Buzzer_init();          /* Initialize Buzzer */
    LEDS_init();            /* Initialize all LEDs */
    Ultrasonic_init();      /* Initialize Ultrasonic sensor */

    /* Enable global interrupts */
    SREG |= (1 << 7);

    /* Display initial message as in PDF */
    LCD_clearScreen();
    LCD_moveCursur(0, 0);
    LCD_displayString("Distance:    cm");

    /* Main application loop */
    while(1)
    {
        /* Read distance from ultrasonic sensor */
        distance = Ultrasonic_readDistance();

        /* Control LEDs and buzzer based on distance */
        ControlIndicators(distance);

        /* Display distance on LCD */
        DisplayDistance(distance);

        /* Wait before next measurement */
        _delay_ms(MEASUREMENT_DELAY);
    }

    return 0;
}
